<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>CanlÄ± MaaÅŸ AÄŸÄ± | BarÄ±ÅŸ Ã–ÄŸretmen</title>
    <meta name="theme-color" content="#4f46e5">
    
    <!-- KÃ¼tÃ¼phaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f8fafc; color: #1e293b; font-family: 'Outfit', sans-serif; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 24px 24px; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(255, 255, 255, 1); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); }
        .gradient-header { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        #global-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.9); backdrop-filter: blur(5px); }
        .admin-controls { display: none; }
        .admin-active .admin-controls { display: table-cell; }
        .admin-active .admin-section { display: block !important; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen font-sans">

    <!-- Loader & Connection Status -->
    <div id="global-loader">
        <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-indigo-900 font-bold text-lg animate-pulse" id="loader-text">CanlÄ± Havuza BaÄŸlanÄ±lÄ±yor...</p>
        <p class="text-xs text-slate-500 mt-2" id="loader-subtext">Veriler senkronize ediliyor</p>
        
        <!-- Hata Kutusu (BaÄŸlantÄ± Olmazsa GÃ¶rÃ¼nÃ¼r) -->
        <div id="error-box" class="hidden mt-6 p-4 bg-red-50 border-l-4 border-red-500 text-left max-w-md mx-4 shadow-lg">
            <h4 class="font-bold text-red-700 text-sm mb-1"><i class="fa-solid fa-triangle-exclamation"></i> BaÄŸlantÄ± Sorunu Tespit Edildi</h4>
            <p id="error-detail" class="text-xs text-red-600 mb-3">...</p>
            <div class="bg-white p-2 rounded text-[10px] font-mono text-slate-600 border border-slate-200 overflow-x-auto">
                <strong>Ã‡Ã¶zÃ¼m Ä°Ã§in Firebase Konsolu'nda YapÄ±lmasÄ± Gerekenler:</strong><br>
                1. <strong>Authentication > Sign-in method</strong> sekmesinde <strong>"Anonymous"</strong> (Anonim) seÃ§eneÄŸini <strong>EtkinleÅŸtir (Enable)</strong> yapÄ±n.<br>
                2. <strong>Firestore Database > Rules</strong> sekmesinde kodu ÅŸu ÅŸekilde deÄŸiÅŸtirip <strong>YayÄ±nla (Publish)</strong> deyin:<br>
                <code class="text-blue-600">allow read, write: if true;</code>
            </div>
            <button onclick="location.reload()" class="mt-4 w-full bg-red-600 text-white py-2 rounded font-bold text-xs hover:bg-red-700">Tekrar Dene</button>
        </div>
    </div>

    <!-- Header -->
    <header class="gradient-header text-white sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2.5 rounded-xl backdrop-blur-sm border border-white/20 shadow-inner">
                    <i class="fa-solid fa-chart-line text-white text-xl md:text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-extrabold text-xl leading-none tracking-tight">MaaÅŸ GÃ¶zlem</h1>
                    <p class="text-[11px] text-indigo-100 opacity-90 mt-0.5 font-medium tracking-wide">BARIÅž Ã–ÄžRETMEN</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="connection-status" class="flex items-center gap-2 bg-black/20 px-3 py-1.5 rounded-full text-xs font-bold border border-white/10 backdrop-blur-md">
                    <span id="status-dot" class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span> <span class="hidden md:inline" id="status-text">BaÄŸlanÄ±yor...</span>
                </span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 space-y-8 relative z-10 max-w-5xl">

        <!-- Admin Panel (Gizli) -->
        <section id="admin-panel" class="hidden admin-section mb-6">
            <div class="bg-slate-800 text-white rounded-xl p-5 shadow-2xl border-2 border-amber-500/50">
                <div class="flex justify-between items-center mb-4 border-b border-slate-600 pb-3">
                    <h3 class="font-bold text-amber-400"><i class="fa-solid fa-user-shield mr-2"></i> YÃ¶netici Kontrol Paneli</h3>
                    <button onclick="adminLogout()" class="text-xs bg-red-600 hover:bg-red-700 px-4 py-1.5 rounded font-bold transition">Ã‡Ä±kÄ±ÅŸ Yap</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="new-announcement" placeholder="Duyuru metni..." class="flex-grow px-4 py-2 rounded bg-slate-700 border border-slate-600 text-white text-sm focus:outline-none focus:border-amber-500">
                    <button onclick="postAnnouncement()" class="bg-amber-600 hover:bg-amber-700 px-6 py-2 rounded text-sm font-bold shadow-lg transition">YayÄ±nla</button>
                </div>
                <div class="mt-3 text-[11px] text-slate-400 flex items-center gap-2">
                    <i class="fa-solid fa-info-circle"></i> Tablodaki [SÄ°L] butonlarÄ± ile hatalÄ± verileri anÄ±nda kaldÄ±rabilirsiniz.
                </div>
            </div>
        </section>

        <!-- Duyuru AlanÄ± -->
        <div id="admin-announcement" class="hidden w-full bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg shadow-sm flex items-start gap-3 animate-pulse-slow">
            <div class="bg-amber-100 text-amber-600 p-2 rounded-full"><i class="fa-solid fa-bullhorn"></i></div>
            <div>
                <h4 class="font-bold text-amber-900 text-sm">YÃ¶netici Duyurusu</h4>
                <p id="announcement-text" class="text-amber-800 text-sm mt-1 font-medium"></p>
            </div>
        </div>

        <!-- GiriÅŸ Intro & CanlÄ± Ä°statistikler -->
        <section class="mb-8 text-center animate-fade-in">
            <h2 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-4 tracking-tight">
                GerÃ§ek <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Piyasa Verileri</span>
            </h2>
            <p class="text-slate-600 max-w-2xl mx-auto mb-8 text-base leading-relaxed">
                Bu platform, sektÃ¶r Ã§alÄ±ÅŸanlarÄ±nÄ±n gerÃ§ek maaÅŸ verilerini anonim olarak paylaÅŸtÄ±ÄŸÄ± <strong>ORTAK BÄ°R HAVUZDUR</strong>.
                GirdiÄŸiniz her veri, anÄ±nda tÃ¼m kullanÄ±cÄ±larÄ±n ekranÄ±na yansÄ±r.
            </p>
            
            <div class="grid grid-cols-3 gap-2 max-w-md mx-auto text-xs font-bold text-slate-600">
                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center gap-1">
                    <i class="fa-solid fa-users text-indigo-500 text-xl"></i>
                    <span>Veri SayÄ±sÄ±: <span id="global-count" class="text-indigo-700">0</span></span>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center gap-1">
                    <i class="fa-solid fa-bolt text-amber-500 text-xl"></i>
                    <span>CanlÄ± AkÄ±ÅŸ</span>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center gap-1">
                    <i class="fa-solid fa-user-secret text-emerald-500 text-xl"></i>
                    <span>%100 Anonim</span>
                </div>
            </div>
        </section>

        <!-- Form -->
        <section id="entry-section" class="max-w-xl mx-auto">
            <div class="glass-panel rounded-3xl p-6 md:p-8 shadow-2xl border-t-4 border-indigo-500 relative overflow-hidden">
                <div class="flex items-center justify-between mb-8">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                        <div class="bg-indigo-100 p-2.5 rounded-xl text-indigo-600"><i class="fa-solid fa-pen-to-square"></i></div> 
                        Veri GiriÅŸi
                    </h3>
                </div>
                
                <form id="salaryForm" class="space-y-6">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 text-xs text-blue-800 rounded-r">
                        <strong>Kural:</strong> Asgari Ã¼cretin (17.002â‚º) altÄ±ndaki giriÅŸler havuza eklenmez.
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">DÃ¶nem</label>
                            <select id="year" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white font-bold text-slate-700 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none">
                                <option value="2026">2026</option>
                                <option value="2025" selected>2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Rumuz</label>
                            <input type="text" id="nickname" required placeholder="Ã–rn: Egitimci34" class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none" maxlength="15">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">BranÅŸ</label>
                        <select id="position" required class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none">
                            <option value="" disabled selected>BranÅŸ SeÃ§iniz...</option>
                            <optgroup label="EÄŸitim"><option value="Uzman Ã–ÄŸretici (Okul Ã–ncesi)">Uzman Ã–ÄŸretici (Okul Ã–ncesi)</option><option value="Uzman Ã–ÄŸretici (Ã‡ocuk GeliÅŸimi)">Uzman Ã–ÄŸretici (Ã‡ocuk GeliÅŸimi)</option><option value="Uzman Ã–ÄŸretici (SÄ±nÄ±f Ã–ÄŸretmenliÄŸi)">Uzman Ã–ÄŸretici (SÄ±nÄ±f Ã–ÄŸrt.)</option><option value="Ã–zel EÄŸitim Ã–ÄŸretmeni">Ã–zel EÄŸitim Ã–ÄŸretmeni</option></optgroup>
                            <optgroup label="Rehberlik"><option value="Psikolog">Psikolog</option><option value="Uzman Psikolog">Uzman Psikolog</option><option value="PDR / Psikolojik DanÄ±ÅŸman">PDR / Psikolojik DanÄ±ÅŸman</option><option value="Uzman PDR">Uzman PDR</option><option value="Rehber Ã–ÄŸretmen">Rehber Ã–ÄŸretmen</option></optgroup>
                            <optgroup label="SaÄŸlÄ±k"><option value="Fizyoterapist">Fizyoterapist</option><option value="Odyolog">Odyolog</option><option value="Dil ve KonuÅŸma Terapisti">Dil ve KonuÅŸma Terapisti</option><option value="Ergoterapist">Ergoterapist</option></optgroup>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Ä°lÃ§e</label>
                            <select id="district" required class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none">
                                <option value="" disabled selected>SeÃ§iniz...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Deneyim</label>
                            <select id="experience" required class="w-full px-3 py-3 rounded-xl border border-slate-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none">
                                <option value="0.5">0-6 Ay</option><option value="0.8">6-12 Ay</option><option value="1">1 YÄ±l</option><option value="2">2 YÄ±l</option><option value="3">3 YÄ±l</option><option value="4">4 YÄ±l</option><option value="5">5 YÄ±l</option><option value="6">6 YÄ±l</option><option value="7">7 YÄ±l</option><option value="8">8 YÄ±l</option><option value="9">9 YÄ±l</option><option value="10">10-14 YÄ±l</option><option value="15">15-19 YÄ±l</option><option value="20">20+ YÄ±l</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Net MaaÅŸ (TL)</label>
                        <input type="number" id="salary" required placeholder="Ã–rn: 32000" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 bg-white text-lg font-bold text-slate-800 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition shadow-sm">
                    </div>

                    <div class="pt-4">
                        <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-bold py-4 rounded-xl transition transform active:scale-[0.98] flex items-center justify-center gap-3 text-lg shadow-xl shadow-indigo-200">
                            <span>Havuza GÃ¶nder</span> <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- SonuÃ§lar EkranÄ± -->
        <section id="results-section" class="hidden space-y-8 pb-12">
            
            <div class="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-indigo-200 pb-4 mb-6">
                <div>
                    <h2 class="text-3xl font-extrabold text-slate-800">CanlÄ± SonuÃ§lar</h2>
                    <p class="text-slate-500 text-sm font-medium mt-1">
                        Ortak Havuzdaki KiÅŸi SayÄ±sÄ±: 
                        <span id="total-participants" class="text-indigo-600 font-bold text-lg bg-indigo-50 px-3 py-0.5 rounded-full border border-indigo-100">--</span>
                    </p>
                </div>
                
                <div class="flex bg-white rounded-xl p-1 shadow-md border border-slate-200">
                    <button onclick="switchResultYear('2024')" id="btn-2024" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-500 transition">2024</button>
                    <button onclick="switchResultYear('2025')" id="btn-2025" class="px-4 py-2 rounded-lg text-sm font-bold bg-indigo-100 text-indigo-700 transition shadow-sm">2025</button>
                    <button onclick="switchResultYear('2026')" id="btn-2026" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-500 transition">2026</button>
                    <button onclick="switchResultYear('all')" id="btn-all" class="px-4 py-2 rounded-lg text-sm font-bold text-indigo-600 border-l border-slate-200 ml-1 transition">TÃ¼mÃ¼</button>
                </div>
            </div>

            <!-- EN SON EKLENEN KAYIT (Ã–NE Ã‡IKARILAN) -->
            <div id="latest-entry-card" class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden hidden">
                <div class="absolute right-0 top-0 opacity-10 text-8xl -mr-4 -mt-4"><i class="fa-solid fa-stopwatch"></i></div>
                <h3 class="font-bold text-lg border-b border-white/20 pb-2 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-bell animate-bounce"></i> SON GÄ°RÄ°LEN KAYIT ANALÄ°ZÄ°
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center md:text-left">
                    <div>
                        <p class="text-xs text-emerald-100 uppercase">Rumuz</p>
                        <p class="font-bold text-lg" id="last-nick">--</p>
                    </div>
                    <div>
                        <p class="text-xs text-emerald-100 uppercase">BranÅŸ</p>
                        <p class="font-bold text-lg" id="last-role">--</p>
                    </div>
                    <div>
                        <p class="text-xs text-emerald-100 uppercase">Ä°lÃ§e</p>
                        <p class="font-bold text-lg" id="last-dist">--</p>
                    </div>
                    <div>
                        <p class="text-xs text-emerald-100 uppercase">Deneyim</p>
                        <p class="font-bold text-lg" id="last-exp">--</p>
                    </div>
                    <div class="bg-white/20 rounded-xl p-2">
                        <p class="text-xs text-white uppercase">MaaÅŸ</p>
                        <p class="font-extrabold text-2xl" id="last-sal">-- â‚º</p>
                    </div>
                </div>
            </div>

            <!-- HIZLI Ä°LÃ‡E SORGULAMA -->
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-magnifying-glass text-indigo-500"></i> Ä°lÃ§e BazlÄ± HÄ±zlÄ± BakÄ±ÅŸ
                </h3>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <select id="quick-district" class="w-full md:w-1/3 px-4 py-3 rounded-xl border-2 border-slate-200 bg-slate-50 focus:border-indigo-500 outline-none" onchange="calculateQuickStats()">
                        <option value="" selected disabled>Ä°lÃ§e SeÃ§iniz...</option>
                        <!-- Populated by JS -->
                    </select>
                    <div class="flex-grow w-full bg-indigo-50 rounded-xl p-4 flex justify-between items-center border border-indigo-100">
                        <span class="text-indigo-800 text-sm font-medium">Bu ilÃ§edeki ortalama:</span>
                        <span id="quick-avg" class="text-2xl font-extrabold text-indigo-600">-- â‚º</span>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Filtrelenen</p>
                    <p class="text-3xl font-extrabold text-slate-800 mt-1" id="stat-count">0</p>
                    <p class="text-xs text-slate-400 mt-1">KiÅŸi</p>
                </div>
                <div class="bg-indigo-600 p-6 rounded-2xl shadow-xl text-white relative overflow-hidden group">
                    <div class="absolute right-0 top-0 opacity-10 text-6xl -mr-4 -mt-4 transform group-hover:scale-110 transition"><i class="fa-solid fa-coins"></i></div>
                    <p class="text-[10px] text-indigo-200 font-bold uppercase tracking-wider">Ortalama MaaÅŸ</p>
                    <p class="text-3xl font-extrabold mt-1" id="stat-avg">-- â‚º</p>
                    <p class="text-xs text-indigo-200 mt-1">Genel Piyasa</p>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Medyan</p>
                    <p class="text-3xl font-extrabold text-indigo-600 mt-1" id="stat-median">-- â‚º</p>
                    <p class="text-xs text-slate-400 mt-1">Orta Nokta</p>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">En YÃ¼ksek</p>
                    <p class="text-3xl font-extrabold text-emerald-600 mt-1" id="stat-max">-- â‚º</p>
                    <p class="text-xs text-slate-400 mt-1">Zirve GiriÅŸ</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-slate-700 text-sm mb-6 flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-map-location-dot"></i></div>
                        Ä°lÃ§e BazlÄ± Ortalamalar
                    </h3>
                    <div class="h-64"><canvas id="districtChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-slate-700 text-sm mb-6 flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-pink-50 text-pink-600 flex items-center justify-center"><i class="fa-solid fa-arrow-trend-up"></i></div>
                        Deneyim - MaaÅŸ EÄŸrisi
                    </h3>
                    <div class="h-64"><canvas id="expChart"></canvas></div>
                </div>
            </div>

            <!-- DISTRICT LEAGUE TABLE -->
            <div class="mt-8 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex justify-between items-center">
                    <h3 class="font-bold text-indigo-800 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-trophy text-yellow-500"></i> Ä°lÃ§e MaaÅŸ Ligi
                    </h3>
                    <span class="text-[10px] text-indigo-400 font-medium">Ortalamaya GÃ¶re SÄ±ralÄ±</span>
                </div>
                <div class="overflow-x-auto max-h-80 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-600">
                        <thead class="bg-slate-50 text-xs font-semibold text-slate-500 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 border-b">SÄ±ra</th>
                                <th class="px-6 py-3 border-b">Ä°lÃ§e</th>
                                <th class="px-6 py-3 border-b">KayÄ±t SayÄ±sÄ±</th>
                                <th class="px-6 py-3 border-b text-right">Ortalama MaaÅŸ</th>
                            </tr>
                        </thead>
                        <tbody id="district-league-body" class="divide-y divide-slate-100 bg-white">
                            <!-- Filled by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Live List -->
            <div class="mt-8 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                        <span class="relative flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                        </span>
                        Son Eklenen Veriler
                    </h3>
                    <span class="text-[10px] bg-white border border-slate-200 px-2 py-1 rounded-full text-slate-500 font-medium">AnlÄ±k AkÄ±ÅŸ</span>
                </div>
                <div class="overflow-x-auto max-h-96 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-600">
                        <thead class="bg-slate-50 text-xs font-semibold text-slate-500 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 border-b">Rumuz</th>
                                <th class="px-6 py-3 border-b">Ä°lÃ§e</th>
                                <th class="px-6 py-3 border-b">Deneyim</th>
                                <th class="px-6 py-3 border-b">MaaÅŸ</th>
                                <th class="px-6 py-3 border-b admin-controls text-right">YÃ¶netim</th>
                            </tr>
                        </thead>
                        <tbody id="live-feed-body" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div class="text-center mt-10 mb-6">
                <button onclick="showFormAgain()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-8 py-4 rounded-full font-bold transition shadow-sm flex items-center gap-2 mx-auto">
                    <i class="fa-solid fa-plus text-indigo-500"></i> Yeni Veri Gir
                </button>
            </div>
        </section>

    </main>

    <footer class="bg-white border-t mt-8 py-12 text-center">
        <div class="container mx-auto px-4">
            <p class="font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 text-2xl mb-6">BarÄ±ÅŸ Ã–ÄŸretmen Projesi</p>
            <div class="max-w-xl mx-auto mb-8 bg-slate-50 p-6 rounded-2xl border border-slate-100 relative">
                <i class="fa-solid fa-quote-left text-slate-200 text-4xl absolute top-3 left-4"></i>
                <p class="text-slate-600 text-base italic relative z-10 font-medium leading-relaxed">
                    "Ben de sizin gibi bir rehabilitasyon merkezi Ã§alÄ±ÅŸanÄ± olarak, Ã¼Ã§ yÄ±ldÄ±r sektÃ¶rÃ¼n tÃ¼m branÅŸlarÄ±na yÃ¶nelik dijital eÄŸitim iÃ§erikleri Ã¼retiyorum. AmacÄ±m emeÄŸimizin karÅŸÄ±lÄ±ÄŸÄ±nÄ± ÅŸeffaflÄ±kla savunmak."
                </p>
            </div>
            <div class="flex flex-wrap justify-center gap-6 text-xs text-slate-400 font-medium tracking-wide uppercase">
                <span>Â© 2025 TÃ¼m HaklarÄ± SaklÄ±dÄ±r</span>
                <span>â€¢</span>
                <span>Veriler %100 Anonimdir</span>
                <span>â€¢</span>
                <span>KÃ¢r AmacÄ± GÃ¼tmez</span>
            </div>
            <button onclick="toggleAdminModal()" class="mt-8 text-slate-200 hover:text-indigo-400 transition p-2"><i class="fa-solid fa-lock"></i></button>
        </div>
    </footer>

    <!-- Admin Login -->
    <div id="admin-modal" class="fixed inset-0 z-50 hidden flex justify-center items-center"><div class="absolute inset-0 modal-overlay" onclick="toggleAdminModal()"></div><div class="bg-white rounded-xl p-8 w-72 shadow-2xl text-center"><h3 class="font-bold mb-6 text-slate-800">YÃ¶netici GiriÅŸi</h3><button onclick="performAdminLogin()" class="w-full bg-slate-800 hover:bg-slate-900 text-white px-4 py-3 rounded-xl font-bold text-sm transition">GiriÅŸ Yap</button></div></div>

    <!-- Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBAL CONFIG
        window.toggleAdminModal = () => document.getElementById('admin-modal').classList.toggle('hidden');
        window.showFormAgain = () => { document.getElementById('results-section').classList.add('hidden'); document.getElementById('entry-section').classList.remove('hidden'); window.scrollTo(0,0); };

        // CONFIGURATION (CANLI BAÄžLANTI)
        const firebaseConfig = {
            apiKey: "AIzaSyAjP5jpALGYWIh8HJmkz9L1x8IikgMxsm4", 
            authDomain: "sekilli-totem-481514-c5.firebaseapp.com",
            projectId: "sekilli-totem-481514-c5",
            storageBucket: "sekilli-totem-481514-c5.firebasestorage.app",
            messagingSenderId: "519295049418",
            appId: "baris-ogretmen-app" 
        };
        const appId = 'baris-ogretmen-app';
        const DISTRICTS = ["Adalar", "ArnavutkÃ¶y", "AtaÅŸehir", "AvcÄ±lar", "BaÄŸcÄ±lar", "BahÃ§elievler", "BakÄ±rkÃ¶y", "BaÅŸakÅŸehir", "BayrampaÅŸa", "BeÅŸiktaÅŸ", "Beykoz", "BeylikdÃ¼zÃ¼", "BeyoÄŸlu", "BÃ¼yÃ¼kÃ§ekmece", "Ã‡atalca", "Ã‡ekmekÃ¶y", "Esenler", "Esenyurt", "EyÃ¼psultan", "Fatih", "GaziosmanpaÅŸa", "GÃ¼ngÃ¶ren", "KadÄ±kÃ¶y", "KaÄŸÄ±thane", "Kartal", "KÃ¼Ã§Ã¼kÃ§ekmece", "Maltepe", "Pendik", "Sancaktepe", "SarÄ±yer", "Silivri", "Sultanbeyli", "Sultangazi", "Åžile", "ÅžiÅŸli", "Tuzla", "Ãœmraniye", "ÃœskÃ¼dar", "Zeytinburnu"];
        const MIN_WAGE = { '2024': 17002, '2025': 22104, '2026': 28075 };
        const ADMIN_HASH = "2070366657"; 

        let db, auth, globalData = [], user = null, isAdmin = false;
        let currentRole, currentDistrict, currentExp, currentSalary, currentViewYear='2025';
        let chartInstances = {};
        let listenersStarted = false;

        async function initApp() {
            populateSelects();
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // FORCE START: Don't wait for auth. 
                // If the user didn't enable "Anonymous Auth" in Firebase Console, 
                // we still try to read/write because Firestore rules might be public.
                signInAnonymously(auth).catch(e => {
                    console.warn("Auth blocked/failed, proceeding in unauthenticated mode", e);
                    // Force start listeners even if auth fails
                    startListeners();
                });
                
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    // If auth succeeds, great. If not, we already tried starting listeners.
                    if(u && !listenersStarted) startListeners();
                });

                // Fail-safe: Always remove loader after 2s
                setTimeout(() => {
                    document.getElementById('global-loader').style.display = 'none';
                    if(!listenersStarted) startListeners(); 
                }, 2000);

            } catch(e) {
                console.error("Init Error", e);
                // Even on critical error, remove loader so user isn't stuck
                document.getElementById('global-loader').style.display = 'none';
                
                // Show a clear error message in place of the loader text IF it's still visible
                const statusEl = document.getElementById('connection-status');
                if(statusEl) statusEl.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full"></span> <span class="text-red-300">BaÄŸlantÄ± HatasÄ±</span>';
                
                // Show specific error if user is admin or on console
                const errorBox = document.createElement('div');
                errorBox.className = "fixed bottom-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg z-50 text-xs";
                errorBox.innerHTML = `<strong>BaÄŸlantÄ± HatasÄ±:</strong><br>${e.message}<br>LÃ¼tfen Firebase Console'dan "Anonymous Auth" ve "Firestore Rules" ayarlarÄ±nÄ± kontrol ediniz.`;
                document.body.appendChild(errorBox);
            }

            document.getElementById('salaryForm').addEventListener('submit', handleFormSubmit);
            window.performAdminLogin = performAdminLogin;
            window.adminLogout = adminLogout;
            window.deleteEntry = deleteEntry;
            window.switchResultYear = switchResultYear;
            window.postAnnouncement = postAnnouncement;
            window.calculateQuickStats = calculateQuickStats;
        }

        function startListeners() {
            if(listenersStarted) return;
            listenersStarted = true;
            
            // Update UI status to show we are live
            const statusEl = document.getElementById('connection-status');
            if(statusEl) statusEl.innerHTML = '<span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> <span class="hidden md:inline text-green-200">CanlÄ±</span>';

            const q = collection(db, 'artifacts', appId, 'public', 'data', 'salaries');
            onSnapshot(q, (snap) => {
                globalData = [];
                snap.forEach(d => globalData.push({ ...d.data(), docId: d.id }));
                
                // Update counters
                const els = ['total-participants', 'global-count'];
                els.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.innerText = globalData.length;
                });

                if(!document.getElementById('results-section').classList.contains('hidden')) updateDashboard();
                updateLiveFeed();
            }, (err) => {
                 console.log("Stream error (likely permission)", err);
                 // If permission error, show alert ONCE
                 if(err.code === 'permission-denied') {
                     const errorBox = document.createElement('div');
                     errorBox.className = "fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full shadow-2xl z-50 font-bold text-sm animate-bounce";
                     errorBox.innerHTML = "<i class='fa-solid fa-lock'></i> ERÄ°ÅžÄ°M REDDEDÄ°LDÄ°: LÃ¼tfen YÃ¶neticiye Bildirin (Firebase KurallarÄ± KapalÄ±)";
                     document.body.appendChild(errorBox);
                 }
            });

            // Announcement
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'admin_announcement', 'main'), (snap) => {
                if(snap && snap.exists() && snap.data().text) {
                    document.getElementById('announcement-text').innerText = snap.data().text;
                    document.getElementById('admin-announcement').classList.remove('hidden');
                }
            }, (e) => {});
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Ä°ÅŸleniyor...";
            btn.disabled = true;

            // Wait a tiny bit for UI update
            await new Promise(r => setTimeout(r, 300));

            const year = document.getElementById('year').value;
            const salary = parseInt(document.getElementById('salary').value);
            
            if(salary < MIN_WAGE[year]) {
                alert(`HATA: ${year} yÄ±lÄ± asgari Ã¼creti (${MIN_WAGE[year]} TL) altÄ±nda giriÅŸ yapÄ±lamaz.`);
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            const data = {
                year, salary,
                nickname: document.getElementById('nickname').value,
                role: document.getElementById('position').value,
                district: document.getElementById('district').value,
                exp: parseFloat(document.getElementById('experience').value),
                timestamp: Date.now(),
                uid: user ? user.uid : 'anon_' + Math.random()
            };

            currentRole = data.role; currentDistrict = data.district; currentExp = data.exp; currentSalary = data.salary; currentViewYear = data.year;

            // FIRE AND FORGET STRATEGY for speed
            // We initiate the write, but immediately show the user the "Success" screen
            // This prevents "hanging" on slow networks.
            
            // 1. Update UI immediately
            document.getElementById('entry-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            renderLatestEntry(data);
            switchResultYear(currentViewYear);
            window.scrollTo(0,0);
            
            // 2. Perform write in background
            addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'salaries'), data)
                .then(() => {
                    console.log("Write success");
                })
                .catch((err) => {
                    console.error("Write failed:", err);
                    // If write fails, the user is already on the results screen.
                    // We can show a toast, or just let them see the cached/live data when it eventually syncs or doesn't.
                    // For a "no stress" experience, we don't alert unless critical.
                    // The live listener will NOT update if write failed, which is expected behavior for offline.
                });

            // Reset button state
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function renderLatestEntry(data) {
            const card = document.getElementById('latest-entry-card');
            if(card) {
                card.classList.remove('hidden');
                document.getElementById('last-nick').innerText = data.nickname;
                document.getElementById('last-role').innerText = data.role;
                document.getElementById('last-dist').innerText = data.district;
                document.getElementById('last-exp').innerText = data.exp + ' YÄ±l';
                document.getElementById('last-sal').innerText = formatCurrency(data.salary);
            }
        }

        function updateDashboard() {
            if(!currentRole) return;
            let d = globalData.filter(x => x.role === currentRole);
            if(currentViewYear !== 'all') d = d.filter(x => x.year === currentViewYear);

            if(d.length === 0) {
                ['count','avg','median','max'].forEach(k => {
                    const el = document.getElementById('stat-'+k);
                    if(el) el.innerText = '-';
                });
                document.getElementById('district-league-body').innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-400">Veri yok</td></tr>';
                return;
            }

            const salaries = d.map(x=>x.salary).sort((a,b)=>a-b);
            const sum = salaries.reduce((a,b)=>a+b,0);
            const avg = Math.round(sum/d.length);
            const mid = Math.floor(salaries.length/2);
            const median = salaries.length%2!==0 ? salaries[mid] : Math.round((salaries[mid-1]+salaries[mid])/2);

            document.getElementById('stat-count').innerText = d.length;
            document.getElementById('stat-avg').innerText = avg.toLocaleString() + ' â‚º';
            document.getElementById('stat-median').innerText = median.toLocaleString() + ' â‚º';
            document.getElementById('stat-max').innerText = salaries[salaries.length-1].toLocaleString() + ' â‚º';

            renderCharts(d);
            renderDistrictLeague(d);
            calculateQuickStats();
        }

        function calculateQuickStats() {
            const selectedDist = document.getElementById('quick-district').value;
            const output = document.getElementById('quick-avg');
            
            if(!selectedDist) { output.innerText = "-- â‚º"; return; }
            
            let filtered = globalData.filter(d => d.district === selectedDist);
            if(currentViewYear !== 'all') filtered = filtered.filter(d => d.year === currentViewYear);
            if(currentRole) filtered = filtered.filter(d => d.role === currentRole);

            if(filtered.length === 0) {
                output.innerText = "Veri Yok";
            } else {
                const avg = filtered.reduce((a,b) => a+b.salary, 0) / filtered.length;
                output.innerText = Math.round(avg).toLocaleString() + ' â‚º';
            }
        }

        function renderDistrictLeague(data) {
            const distStats = {};
            data.forEach(d => {
                if(!distStats[d.district]) distStats[d.district] = { sum: 0, count: 0 };
                distStats[d.district].sum += d.salary;
                distStats[d.district].count++;
            });

            const sortedDistricts = Object.keys(distStats)
                .map(dist => ({
                    name: dist,
                    count: distStats[dist].count,
                    avg: Math.round(distStats[dist].sum / distStats[dist].count)
                }))
                .sort((a, b) => b.avg - a.avg);

            const tbody = document.getElementById('district-league-body');
            tbody.innerHTML = '';
            
            if(sortedDistricts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-400">Bu kriterlerde veri bulunamadÄ±</td></tr>';
                return;
            }
            
            sortedDistricts.forEach((item, index) => {
                let rankClass = "text-slate-500 font-bold";
                let rankIcon = "";
                if(index === 0) { rankClass="text-yellow-500 font-extrabold"; rankIcon="ðŸ‘‘"; }
                else if(index === 1) { rankClass="text-slate-400 font-bold"; rankIcon="ðŸ¥ˆ"; }
                else if(index === 2) { rankClass="text-amber-700 font-bold"; rankIcon="ðŸ¥‰"; }

                tbody.innerHTML += `
                    <tr class="hover:bg-indigo-50/30 transition border-b border-slate-50">
                        <td class="px-6 py-3 ${rankClass}">${rankIcon} ${index+1}.</td>
                        <td class="px-6 py-3 font-medium text-slate-700">${item.name}</td>
                        <td class="px-6 py-3 text-slate-500">${item.count} KiÅŸi</td>
                        <td class="px-6 py-3 text-right font-bold text-indigo-600">${formatCurrency(item.avg)}</td>
                    </tr>
                `;
            });
        }

        function renderCharts(data) {
            const distMap = {}, expMap = {};
            data.forEach(x => {
                if(!distMap[x.district]) distMap[x.district] = {s:0,c:0}; distMap[x.district].s+=x.salary; distMap[x.district].c++;
                if(!expMap[x.exp]) expMap[x.exp] = {s:0,c:0}; expMap[x.exp].s+=x.salary; expMap[x.exp].c++;
            });

            if(chartInstances.d) chartInstances.d.destroy();
            chartInstances.d = new Chart(document.getElementById('districtChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(distMap),
                    datasets: [{ label: 'Ortalama', data: Object.keys(distMap).map(k=>Math.round(distMap[k].s/distMap[k].c)), backgroundColor: '#6366f1', borderRadius:6 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: true, ticks: { maxRotation: 90, font:{size:10} } } } }
            });

            if(chartInstances.e) chartInstances.e.destroy();
            const eKeys = Object.keys(expMap).sort((a,b)=>parseFloat(a)-parseFloat(b));
            chartInstances.e = new Chart(document.getElementById('expChart'), {
                type: 'line',
                data: {
                    labels: eKeys.map(v=>v==0.5?'0-6 Ay':(v==0.8?'6-12 Ay':v+' YÄ±l')),
                    datasets: [{ label: 'MaaÅŸ EÄŸrisi', data: eKeys.map(k=>Math.round(expMap[k].s/expMap[k].c)), borderColor: '#10b981', tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateLiveFeed() {
            const t = document.getElementById('live-feed-body');
            t.innerHTML = '';
            const sorted = [...globalData].sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).slice(0,50);
            
            sorted.forEach(d => {
                let expText = d.exp + " YÄ±l";
                if(d.exp == 0.5) expText = "0-6 Ay";
                if(d.exp == 0.8) expText = "6-12 Ay";

                t.innerHTML += `<tr class="border-b hover:bg-slate-50 transition">
                    <td class="px-6 py-3 font-medium text-slate-800">${d.nickname}</td>
                    <td class="px-6 py-3 text-slate-600">${d.district}</td>
                    <td class="px-6 py-3 text-xs font-bold text-slate-500">${expText}</td>
                    <td class="px-6 py-3 font-bold text-green-600">${formatCurrency(d.salary)}</td>
                    <td class="px-6 py-3 text-right admin-controls"><button onclick="deleteEntry('${d.docId}')" class="text-red-500 text-xs border border-red-200 px-2 py-1 rounded hover:bg-red-50 font-bold">SÄ°L</button></td>
                </tr>`;
            });
        }

        function simpleHash(str) { let h=0; for(let i=0;i<str.length;i++) h=Math.imul(31,h)+str.charCodeAt(i)|0; return h.toString(); }
        function performAdminLogin() { if(simpleHash(prompt("Åžifre:")) === ADMIN_HASH) { isAdmin=true; document.body.classList.add('admin-active'); toggleAdminModal(); alert("GiriÅŸ BaÅŸarÄ±lÄ±"); } else alert("HatalÄ±"); }
        function adminLogout() { isAdmin=false; document.body.classList.remove('admin-active'); }
        async function deleteEntry(id) { if(isAdmin && confirm("Silinsin mi?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'salaries', id)); }
        async function postAnnouncement() { if(isAdmin) { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'admin_announcement', 'main'), { text: document.getElementById('new-announcement').value }); alert("YayÄ±nlandÄ±"); } }

        function formatCurrency(val) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(val); }

        function populateSelects() {
            const el = document.getElementById('district');
            const quickEl = document.getElementById('quick-district');
            DISTRICTS.forEach(d => { 
                const o=document.createElement('option'); o.value=d; o.innerText=d; el.appendChild(o); 
                const q=document.createElement('option'); q.value=d; q.innerText=d; quickEl.appendChild(q);
            });
        }
        function switchResultYear(y) {
            currentViewYear = y;
            ['2024','2025','2026','all'].forEach(x => {
                document.getElementById('btn-'+x).className = (x===y) ? "px-4 py-2 rounded-lg text-sm bg-indigo-100 text-indigo-700 font-bold transition shadow-sm" : "px-4 py-2 rounded-lg text-sm text-slate-500 hover:bg-slate-50 transition";
            });
            updateDashboard();
        }

        initApp();
    </script>
</body>
</html>
