<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Maaş Gözlem 2.0 | Barış Öğretmen</title>
    <meta name="description" content="Rehabilitasyon ve Özel Eğitim sektörü canlı maaş veritabanı ve analiz platformu.">
    
    <!-- Kütüphaneler -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Toast Bildirimleri -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e5e7eb; }
        .stat-card { transition: all 0.2s ease; }
        .stat-card:active { transform: scale(0.98); }
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .loader-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; }
        
        /* Tab Geçiş Animasyonları */
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Haber Bandı Animasyonu */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 45s linear infinite; padding-left: 100%; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen">

    <!-- Yükleme Ekranı -->
    <div id="app-loader" class="loader-overlay">
        <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold text-slate-800">Sisteme Bağlanılıyor...</h2>
        <p class="text-sm text-slate-500 mt-2 text-center">Mobil bağlantı optimize ediliyor.</p>
        
        <!-- Hata Mesajı Alanı -->
        <div id="error-container" class="hidden mt-6 bg-red-50 border border-red-200 p-4 rounded-xl max-w-sm w-full text-center">
            <div class="text-red-500 text-3xl mb-2"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h3 class="font-bold text-red-700 mb-1" id="error-title">Bağlantı Hatası</h3>
            <p class="text-xs text-red-600 mb-3" id="error-desc">Veritabanına erişilemedi.</p>
            <button onclick="location.reload()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-xs font-bold w-full">Tekrar Dene</button>
        </div>
    </div>

    <!-- Haber Bandı -->
    <div class="bg-indigo-900 text-white text-xs py-2 font-medium relative z-40 border-b border-indigo-800 overflow-hidden">
        <div class="marquee-container">
            <div id="marquee-text" class="marquee-content">
                Rehabilitasyon merkezlerinde 10 yılı aşkın süredir edindiğim deneyim ve son 3 yıldır her modüle uygun ürettiğim dijital eğitim içerikleriyle, bu alandaki ihtiyaca kalıcı bir çözüm sunmak amacıyla bu platformu hayata geçirdim. Soru ve görüşleriniz için her zaman bana ulaşabilirsiniz. &nbsp; • &nbsp; Maaş Gözlem Platformu &nbsp; • &nbsp; Barış Öğretmen
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-header sticky top-0 z-30">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3" onclick="location.reload()">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-200">
                    <i class="fa-solid fa-chart-simple text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-slate-800">Maaş Gözlem</h1>
                    <p class="text-[10px] font-semibold text-blue-600 tracking-wider uppercase">Barış Öğretmen</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <div class="hidden md:flex flex-col items-end mr-4">
                    <span class="text-[10px] text-slate-400 font-bold uppercase">Toplam Kayıt</span>
                    <span id="header-total-count" class="text-lg font-bold text-slate-800 leading-none">0</span>
                </div>
                <button onclick="toggleAdminPanel()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Ana İçerik -->
    <main class="flex-grow container mx-auto px-4 py-6 max-w-6xl">

        <!-- Tab Navigasyon -->
        <div class="flex p-1 bg-white rounded-xl shadow-sm border border-slate-200 mb-6 max-w-md mx-auto">
            <button onclick="switchTab('entry')" id="tab-btn-entry" class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all text-white bg-blue-600 shadow-sm flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus-circle"></i> Veri Gir
            </button>
            <button onclick="switchTab('explore')" id="tab-btn-explore" class="flex-1 py-2.5 text-sm font-bold rounded-lg transition-all text-slate-500 hover:bg-slate-50 flex items-center justify-center gap-2">
                <i class="fa-solid fa-search"></i> Verileri İncele
            </button>
        </div>

        <!-- YÖNETİCİ DUYURUSU (Her iki sekmede de görünür eğer varsa) -->
        <div id="global-announcement" class="hidden max-w-4xl mx-auto mb-6 bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r shadow-sm">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-bullhorn text-amber-500 mt-0.5"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-amber-800 font-bold">Yönetici Duyurusu</p>
                    <p id="announcement-text" class="text-sm text-amber-700 mt-1"></p>
                </div>
            </div>
        </div>

        <!-- 1. SEKME: VERİ GİRİŞİ -->
        <div id="tab-entry" class="tab-content active max-w-lg mx-auto">
            <div class="bg-white rounded-2xl p-6 shadow-lg border border-slate-100 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-50 rounded-full blur-3xl"></div>
                <h2 class="text-xl font-bold text-slate-800 mb-1 relative z-10">Maaşını Paylaş</h2>
                <p class="text-sm text-slate-500 mb-6 relative z-10">Veriler %100 anonimdir ve veritabanına kaydedilir.</p>

                <form id="salaryForm" class="space-y-4 relative z-10">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Yıl</label>
                            <select id="entry-year" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-3 font-semibold outline-none transition">
                                <option value="2026">2026</option>
                                <option value="2025" selected>2025</option>
                                <option value="2024">2024</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Rumuz</label>
                            <input type="text" id="entry-nick" maxlength="12" placeholder="Örn: Mavi" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-3 outline-none transition" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Branş</label>
                        <select id="entry-role" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-3 outline-none transition" required>
                            <option value="" disabled selected>Branş Seçiniz...</option>
                            <optgroup label="Eğitim">
                                <option value="Uzman Öğretici (Okul Öncesi)">Uzman Öğretici (Okul Öncesi)</option>
                                <option value="Uzman Öğretici (Çocuk Gelişimi)">Uzman Öğretici (Çocuk Gelişimi)</option>
                                <option value="Uzman Öğretici (Sınıf Öğrt.)">Uzman Öğretici (Sınıf Öğrt.)</option>
                                <option value="Özel Eğitim Öğretmeni">Özel Eğitim Öğretmeni</option>
                            </optgroup>
                            <optgroup label="Rehberlik">
                                <option value="Psikolog">Psikolog</option>
                                <option value="PDR / Psikolojik Danışman">PDR / Psikolojik Danışman</option>
                                <option value="Rehber Öğretmen">Rehber Öğretmen</option>
                            </optgroup>
                            <optgroup label="Sağlık">
                                <option value="Fizyoterapist">Fizyoterapist</option>
                                <option value="Dil ve Konuşma Terapisti">Dil ve Konuşma Terapisti</option>
                                <option value="Ergoterapist">Ergoterapist</option>
                                <option value="Odyolog">Odyolog</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">İlçe</label>
                            <select id="entry-district" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-3 outline-none transition" required>
                                <option value="" disabled selected>Seç...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Deneyim</label>
                            <select id="entry-exp" class="w-full bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-3 outline-none transition" required>
                                <option value="0.5">0-6 Ay</option>
                                <option value="1">1 Yıl</option>
                                <option value="2">2 Yıl</option>
                                <option value="3">3 Yıl</option>
                                <option value="4">4 Yıl</option>
                                <option value="5">5 Yıl</option>
                                <option value="6">6-9 Yıl</option>
                                <option value="10">10+ Yıl</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Net Maaş (TL)</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-slate-400 font-bold">₺</span>
                            </div>
                            <input type="number" id="entry-salary" placeholder="Örn: 35000" class="w-full pl-8 bg-white border-2 border-slate-200 text-slate-900 text-lg font-bold rounded-xl focus:ring-blue-500 focus:border-blue-500 block p-3 outline-none transition" required>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">* Asgari ücret altı girişler sisteme kaydedilmez.</p>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-bold rounded-xl text-sm px-5 py-4 text-center transition-all shadow-lg shadow-blue-200 flex items-center justify-center gap-2 mt-2">
                        <span>Havuza Gönder</span>
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
            
            <div class="mt-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 ml-1">Son Eklenenler</h3>
                <div id="mini-feed" class="space-y-2"></div>
            </div>
        </div>

        <!-- 2. SEKME: VERİ İNCELEME (DASHBOARD) -->
        <div id="tab-explore" class="tab-content">
            
            <!-- Filtre Alanı -->
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6">
                <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-filter text-blue-500"></i> Filtreleme Seçenekleri
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <select id="filter-year" onchange="applyFilters()" class="bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg p-2.5 font-bold outline-none">
                        <option value="all">Tüm Yıllar</option>
                        <option value="2025" selected>2025</option>
                        <option value="2024">2024</option>
                    </select>
                    <select id="filter-role" onchange="applyFilters()" class="bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg p-2.5 outline-none">
                        <option value="all">Tüm Branşlar</option>
                    </select>
                    <select id="filter-district" onchange="applyFilters()" class="bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-lg p-2.5 outline-none">
                        <option value="all">Tüm İlçeler</option>
                    </select>
                    <button onclick="resetFilters()" class="bg-red-50 text-red-600 hover:bg-red-100 text-xs font-bold rounded-lg p-2.5 transition">
                        Filtreleri Temizle
                    </button>
                </div>
            </div>

            <!-- Özet Kartlar -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Veri Sayısı</p>
                    <h4 id="stat-count" class="text-2xl font-black text-slate-800">0</h4>
                </div>
                <div class="bg-blue-600 p-4 rounded-xl shadow-lg shadow-blue-200 text-white">
                    <p class="text-[10px] text-blue-100 font-bold uppercase">Ortalama Maaş</p>
                    <h4 id="stat-avg" class="text-2xl font-black">0 ₺</h4>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">En Düşük</p>
                    <h4 id="stat-min" class="text-2xl font-black text-red-500">0 ₺</h4>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">En Yüksek</p>
                    <h4 id="stat-max" class="text-2xl font-black text-emerald-500">0 ₺</h4>
                </div>
            </div>

            <!-- Grafikler -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-slate-700 text-xs mb-4">Deneyim Bazlı Ortalama</h3>
                    <div class="h-64"><canvas id="chartExp"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-slate-700 text-xs mb-4">En Yüksek Ortalamaya Sahip 5 İlçe</h3>
                    <div class="h-64"><canvas id="chartDistrict"></canvas></div>
                </div>
            </div>

            <!-- Detaylı Liste -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="px-5 py-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 text-xs">Detaylı Liste</h3>
                    <span class="text-[10px] text-slate-400 bg-white border border-slate-200 px-2 py-1 rounded">Son 100 Kayıt</span>
                </div>
                <div class="overflow-x-auto max-h-96 custom-scroll">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50 text-slate-400 font-bold uppercase sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3">Rumuz</th>
                                <th class="px-4 py-3">Branş</th>
                                <th class="px-4 py-3">İlçe</th>
                                <th class="px-4 py-3">Tecrübe</th>
                                <th class="px-4 py-3 text-right">Maaş</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100 text-slate-600"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <footer class="mt-auto py-8 text-center bg-white border-t border-slate-100">
        <!-- Diğer Proje Linki -->
        <div class="mb-6">
            <a href="https://baris-ogretmen.github.io/beyazit-kisa-s-reli-bellek/" target="_blank" class="inline-flex items-center gap-2 bg-indigo-50 border border-indigo-100 px-5 py-3 rounded-full text-xs font-bold text-indigo-700 hover:bg-indigo-100 hover:shadow-md transition group">
                <span class="bg-white p-1.5 rounded-full text-indigo-500 group-hover:scale-110 transition shadow-sm"><i class="fa-solid fa-gamepad"></i></span>
                <span>Diğer Çalışmam: Beyazıt Kısa Süreli Bellek</span>
                <i class="fa-solid fa-arrow-up-right-from-square text-[10px] opacity-50"></i>
            </a>
        </div>
        
        <p class="font-bold text-slate-600 text-xs mb-1">Maaş Gözlem v2.0</p>
        <p class="text-slate-400 text-[10px] font-medium">Barış Öğretmen | %100 Anonim Veri Ağı</p>
    </footer>

    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-slate-900/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-bold text-lg text-slate-800">Yönetici Paneli</h3>
                <button onclick="toggleAdminPanel()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div id="admin-login-view">
                <p class="text-xs text-slate-500 mb-2">Devam etmek için şifreyi giriniz.</p>
                <input type="password" id="admin-pass" placeholder="Şifre" class="w-full border-2 border-slate-200 p-2.5 rounded-xl mb-3 text-center outline-none focus:border-blue-500 transition font-bold">
                <button onclick="adminLogin()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-700 transition">Giriş Yap</button>
            </div>
            
            <div id="admin-controls-view" class="hidden space-y-5">
                <!-- Haber Bandı Ayarı -->
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                    <label class="block text-xs font-bold text-indigo-800 mb-2"><i class="fa-solid fa-newspaper mr-1"></i> Haber Bandını Güncelle</label>
                    <textarea id="admin-ticker-input" rows="3" class="w-full p-2 text-xs border border-indigo-200 rounded-lg mb-2 focus:outline-none focus:border-indigo-500" placeholder="Kayan yazı metni..."></textarea>
                    <button onclick="updateTicker()" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 transition">Güncelle</button>
                </div>

                <!-- Duyuru Ayarı -->
                <div class="bg-amber-50 p-4 rounded-xl border border-amber-100">
                    <label class="block text-xs font-bold text-amber-800 mb-2"><i class="fa-solid fa-bullhorn mr-1"></i> Grup Duyurusu Yap</label>
                    <textarea id="admin-announce-input" rows="3" class="w-full p-2 text-xs border border-amber-200 rounded-lg mb-2 focus:outline-none focus:border-amber-500" placeholder="Duyuru metni... (Boş bırakırsanız gizlenir)"></textarea>
                    <button onclick="updateAnnouncement()" class="w-full bg-amber-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-amber-700 transition">Yayınla / Gizle</button>
                </div>

                <hr class="border-slate-100">

                <!-- Veri Temizleme -->
                <div>
                    <h4 class="text-xs font-bold text-red-500 mb-2">Tehlikeli Bölge</h4>
                    <p class="text-[10px] text-slate-400 mb-2">Hatalı kayıtları silmek için "Verileri İncele" sekmesindeki çöp kutusu ikonlarını kullanın.</p>
                    <button onclick="logoutAdmin()" class="w-full bg-slate-100 text-slate-600 py-3 rounded-xl text-xs font-bold hover:bg-slate-200">Çıkış Yap</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc, enableIndexedDbPersistence, initializeFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- AYARLAR ---
        const DISTRICTS = ["Adalar", "Arnavutköy", "Ataşehir", "Avcılar", "Bağcılar", "Bahçelievler", "Bakırköy", "Başakşehir", "Bayrampaşa", "Beşiktaş", "Beykoz", "Beylikdüzü", "Beyoğlu", "Büyükçekmece", "Çatalca", "Çekmeköy", "Esenler", "Esenyurt", "Eyüpsultan", "Fatih", "Gaziosmanpaşa", "Güngören", "Kadıköy", "Kağıthane", "Kartal", "Küçükçekmece", "Maltepe", "Pendik", "Sancaktepe", "Sarıyer", "Silivri", "Sultanbeyli", "Sultangazi", "Şile", "Şişli", "Tuzla", "Ümraniye", "Üsküdar", "Zeytinburnu"];
        const MIN_WAGE = { '2024': 17002, '2025': 22104, '2026': 28000 };
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'maas-gozlem-v2';
        const COLLECTION = 'salary_records';
        const SETTINGS_DOC = 'global_settings'; // Ayarların tutulacağı döküman
        const ADMIN_PASS = "1453"; 
        
        let db, auth, user;
        let globalData = [];
        let chartInstances = {};
        let isAdmin = false;

        // --- BAŞLATMA ---
        async function init() {
            populateSelects();
            
            try {
                // Dinamik veya Statik Config Seçimi (Fallback Logic)
                let firebaseConfig;
                if(typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config);
                } else {
                    // YEDEK CONFIG (Mobil ve farklı domainler için)
                    firebaseConfig = {
                        apiKey: "AIzaSyAjP5jpALGYWIh8HJmkz9L1x8IikgMxsm4", 
                        authDomain: "sekilli-totem-481514-c5.firebaseapp.com",
                        projectId: "sekilli-totem-481514-c5",
                        storageBucket: "sekilli-totem-481514-c5.firebasestorage.app",
                        messagingSenderId: "519295049418",
                        appId: APP_ID
                    };
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                
                // MOBİL İÇİN KRİTİK: Persistence Ayarı
                try {
                    await setPersistence(auth, browserLocalPersistence);
                } catch(err) {
                    console.warn("Persistence warning:", err);
                }

                db = initializeFirestore(app, { experimentalForceLongPolling: true });

                // Çevrimdışı destek (Mobil iframe'de hata verebilir, yutuyoruz)
                try { await enableIndexedDbPersistence(db); } catch(e) {}

                onAuthStateChanged(auth, (u) => {
                    if(u) {
                        user = u;
                        startRealtimeListener();
                        startSettingsListener(); 
                    }
                });

                // GİRİŞ DENEMESİ
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (authError) {
                    console.error("Auth Failed:", authError);
                    showConnectionError(authError);
                }

            } catch (error) {
                console.error("Init error", error);
                showConnectionError(error);
            }
        }

        function showConnectionError(error) {
            document.getElementById('app-loader').classList.remove('hidden'); // Loader kalsın
            document.querySelector('#app-loader .animate-spin').classList.add('hidden'); // Spinner gitsin
            document.querySelector('#app-loader h2').innerText = "Bağlantı Kurulamadı";
            document.querySelector('#app-loader p').innerText = "Lütfen aşağıdakileri kontrol edin:";
            
            const errContainer = document.getElementById('error-container');
            const errTitle = document.getElementById('error-title');
            const errDesc = document.getElementById('error-desc');
            
            errContainer.classList.remove('hidden');
            
            if (error.code === 'auth/requests-from-referer-blocked') { // Domain hatası
                errTitle.innerText = "Domain İzni Yok";
                errDesc.innerText = "Bu web sitesi adresi (domain), veritabanı güvenlik listesinde yok. Lütfen doğru adresten girdiğinize emin olun.";
            } else if (error.code === 'auth/network-request-failed') { // İnternet yok
                errTitle.innerText = "İnternet Yok";
                errDesc.innerText = "Lütfen internet bağlantınızı kontrol edip tekrar deneyin.";
            } else {
                errTitle.innerText = "Sistem Hatası";
                errDesc.innerText = "Kod: " + (error.code || error.message);
            }
        }

        // --- VERİ DİNLEME ---
        function startRealtimeListener() {
            const q = collection(db, 'artifacts', APP_ID, 'public', 'data', COLLECTION);
            
            onSnapshot(q, (snapshot) => {
                globalData = [];
                snapshot.forEach(doc => {
                    globalData.push({ id: doc.id, ...doc.data() });
                });
                document.getElementById('app-loader').classList.add('hidden'); // Başarılıysa gizle
                updateHeaderCount();
                updateMiniFeed();
                applyFilters();
            }, (error) => {
                if(error.code === 'permission-denied') {
                    document.getElementById('db-error-msg').classList.remove('hidden');
                } else {
                    showConnectionError(error);
                }
            });
        }

        // --- AYAR DİNLEME (Haber Bandı ve Duyuru) ---
        function startSettingsListener() {
            const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', SETTINGS_DOC);
            
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.tickerText) {
                        document.getElementById('marquee-text').innerHTML = data.tickerText;
                    }
                    const announceBox = document.getElementById('global-announcement');
                    if(data.announcementText && data.announcementText.trim() !== "") {
                        document.getElementById('announcement-text').innerHTML = data.announcementText;
                        announceBox.classList.remove('hidden');
                    } else {
                        announceBox.classList.add('hidden');
                    }
                } else {
                    // Varsayılan değer yoksa oluştur
                     setDoc(docRef, {
                         tickerText: 'Rehabilitasyon merkezlerinde 10 yılı aşkın süredir edindiğim deneyim ve son 3 yıldır her modüle uygun ürettiğim dijital eğitim içerikleriyle, bu alandaki ihtiyaca kalıcı bir çözüm sunmak amacıyla bu platformu hayata geçirdim. Soru ve görüşleriniz için her zaman bana ulaşabilirsiniz. &nbsp; • &nbsp; Maaş Gözlem Platformu &nbsp; • &nbsp; Barış Öğretmen',
                         announcementText: ''
                     });
                }
            });
        }

        // --- FORM İŞLEMLERİ ---
        window.handleFormSubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            
            const year = document.getElementById('entry-year').value;
            const salary = parseInt(document.getElementById('entry-salary').value);
            const role = document.getElementById('entry-role').value;
            const district = document.getElementById('entry-district').value;
            const exp = parseFloat(document.getElementById('entry-exp').value);
            const nick = document.getElementById('entry-nick').value || "Anonim";

            if(salary < MIN_WAGE[year]) { showToast(`${year} asgari ücreti (${MIN_WAGE[year]} TL) altı girilemez.`, "error"); return; }
            if(salary > 300000) { showToast(`Maaş çok yüksek, kontrol ediniz.`, "error"); return; }

            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Kaydediliyor...`;
            btn.disabled = true;

            try {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', COLLECTION), {
                    year, salary, role, district, exp, nickname: nick,
                    uid: user.uid, timestamp: Date.now()
                });
                showToast("Veri eklendi!", "success");
                document.getElementById('salaryForm').reset();
                switchTab('explore');
                document.getElementById('filter-year').value = year;
                applyFilters();
            } catch (error) {
                console.error(error);
                if(error.code === 'permission-denied') {
                    showToast("Yazma izni yok! (Rules kontrol edin)", "error");
                } else {
                    showToast("Kayıt başarısız: " + error.code, "error");
                }
            } finally {
                btn.innerHTML = `<span>Havuza Gönder</span><i class="fa-solid fa-paper-plane"></i>`;
                btn.disabled = false;
            }
        };

        document.getElementById('salaryForm').addEventListener('submit', window.handleFormSubmit);

        // --- DASHBOARD ---
        window.applyFilters = () => {
            const fYear = document.getElementById('filter-year').value;
            const fRole = document.getElementById('filter-role').value;
            const fDist = document.getElementById('filter-district').value;
            let filtered = globalData;
            if(fYear !== 'all') filtered = filtered.filter(d => d.year == fYear);
            if(fRole !== 'all') filtered = filtered.filter(d => d.role == fRole);
            if(fDist !== 'all') filtered = filtered.filter(d => d.district == fDist);
            renderStats(filtered);
            renderCharts(filtered);
            renderTable(filtered);
        };

        function renderStats(data) {
            document.getElementById('stat-count').innerText = data.length;
            if(data.length === 0) { ['avg', 'min', 'max'].forEach(k => document.getElementById('stat-'+k).innerText = "0 ₺"); return; }
            const s = data.map(d => d.salary);
            const sum = s.reduce((a,b) => a+b, 0);
            document.getElementById('stat-avg').innerText = formatMoney(Math.round(sum / data.length));
            document.getElementById('stat-min').innerText = formatMoney(Math.min(...s));
            document.getElementById('stat-max').innerText = formatMoney(Math.max(...s));
        }

        function renderCharts(data) {
            if(data.length === 0) {
                if(chartInstances.exp) chartInstances.exp.destroy();
                if(chartInstances.dist) chartInstances.dist.destroy();
                return;
            }
            // Exp Chart
            const eG = {}; data.forEach(d => { if(!eG[d.exp]) eG[d.exp]={s:0,c:0}; eG[d.exp].s+=d.salary; eG[d.exp].c++; });
            const eL = Object.keys(eG).sort((a,b)=>parseFloat(a)-parseFloat(b));
            updateChart('chartExp', 'line', eL.map(v=>v==0.5?"0-6 Ay":(v==10?"10+ Yıl":v+" Yıl")), eL.map(k=>Math.round(eG[k].s/eG[k].c)), 'Maaş', '#3b82f6');
            
            // District Chart
            const dG = {}; data.forEach(d => { if(!dG[d.district]) dG[d.district]={s:0,c:0}; dG[d.district].s+=d.salary; dG[d.district].c++; });
            const sorted = Object.keys(dG).map(k=>({n:k,a:Math.round(dG[k].s/dG[k].c)})).sort((a,b)=>b.a-a.a).slice(0,5);
            updateChart('chartDistrict', 'bar', sorted.map(x=>x.n), sorted.map(x=>x.a), 'Ortalama', '#10b981');
        }

        function updateChart(cid, type, labels, data, label, color) {
            const ctx = document.getElementById(cid).getContext('2d');
            if(cid === 'chartExp' && chartInstances.exp) chartInstances.exp.destroy();
            if(cid === 'chartDistrict' && chartInstances.dist) chartInstances.dist.destroy();
            const nc = new Chart(ctx, { type, data: { labels, datasets: [{ label, data, backgroundColor: color, borderColor: color, tension: 0.3, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            if(cid === 'chartExp') chartInstances.exp = nc;
            if(cid === 'chartDistrict') chartInstances.dist = nc;
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            [...data].sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).slice(0,100).forEach(d => {
                let del = isAdmin ? `<button onclick="deleteRecord('${d.id}')" class="ml-2 text-red-500"><i class="fa-solid fa-trash"></i></button>` : '';
                tbody.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-50"><td class="px-4 py-3 font-medium">${d.nickname}</td><td class="px-4 py-3">${d.role}</td><td class="px-4 py-3 text-slate-500">${d.district}</td><td class="px-4 py-3 text-xs font-bold text-slate-400">${d.exp==0.5?"0-6 Ay":d.exp+" Yıl"}</td><td class="px-4 py-3 text-right font-bold text-blue-600 flex justify-end items-center">${formatMoney(d.salary)} ${del}</td></tr>`;
            });
        }

        // --- YÖNETİCİ & AYARLAR FONKSİYONLARI ---
        window.toggleAdminPanel = () => document.getElementById('admin-modal').classList.toggle('hidden');
        
        window.adminLogin = () => {
            if(document.getElementById('admin-pass').value === ADMIN_PASS) {
                isAdmin = true;
                document.getElementById('admin-login-view').classList.add('hidden');
                document.getElementById('admin-controls-view').classList.remove('hidden');
                showToast("Yönetici girişi başarılı", "success");
                applyFilters(); // Sil butonlarını aktif et
            } else {
                showToast("Şifre Hatalı!", "error");
            }
        };

        window.logoutAdmin = () => {
            isAdmin = false;
            document.getElementById('admin-login-view').classList.remove('hidden');
            document.getElementById('admin-controls-view').classList.add('hidden');
            document.getElementById('admin-pass').value = '';
            showToast("Çıkış yapıldı");
            applyFilters();
        };

        window.updateTicker = async () => {
            const txt = document.getElementById('admin-ticker-input').value;
            if(!txt) return;
            try {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', SETTINGS_DOC), { tickerText: txt }, { merge: true });
                showToast("Haber bandı güncellendi", "success");
            } catch(e) { showToast("Güncelleme hatası", "error"); }
        };

        window.updateAnnouncement = async () => {
            const txt = document.getElementById('admin-announce-input').value;
            try {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', SETTINGS_DOC), { announcementText: txt }, { merge: true });
                showToast("Duyuru güncellendi", "success");
            } catch(e) { showToast("Güncelleme hatası", "error"); }
        };

        window.deleteRecord = async (id) => {
            if(!confirm("Silmek istediğine emin misin?")) return;
            await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', COLLECTION, id));
            showToast("Kayıt silindi", "success");
        };

        // --- GENEL UTILS ---
        window.switchTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            const b1 = document.getElementById('tab-btn-entry'), b2 = document.getElementById('tab-btn-explore');
            const act = "flex-1 py-2.5 text-sm font-bold rounded-lg transition-all text-white bg-blue-600 shadow-sm flex items-center justify-center gap-2";
            const pas = "flex-1 py-2.5 text-sm font-bold rounded-lg transition-all text-slate-500 hover:bg-slate-50 flex items-center justify-center gap-2";
            b1.className = t==='entry'?act:pas; b2.className = t==='explore'?act:pas;
            if(t==='explore') applyFilters();
        };

        function updateHeaderCount() { document.getElementById('header-total-count').innerText = globalData.length; }
        function updateMiniFeed() {
            const f = document.getElementById('mini-feed'); f.innerHTML = '';
            [...globalData].sort((a,b)=>(b.timestamp||0)-(a.timestamp||0)).slice(0,3).forEach(d => {
                f.innerHTML += `<div class="flex justify-between items-center bg-slate-50 p-2.5 rounded-lg border border-slate-100 text-xs"><div><span class="font-bold text-slate-700">${d.role}</span><span class="text-slate-400 mx-1">•</span><span class="text-slate-500">${d.district}</span></div><span class="font-bold text-blue-600">${formatMoney(d.salary)}</span></div>`;
            });
            if(globalData.length===0) f.innerHTML = '<p class="text-xs text-slate-400 italic pl-1">Henüz veri yok.</p>';
        }

        function formatMoney(n) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(n); }
        window.showToast = (msg, type='info') => Toastify({ text: msg, duration: 3000, gravity: "top", position: "center", backgroundColor: type==='error'?"#ef4444":(type==='success'?"#10b981":"#3b82f6"), className: "rounded-lg font-bold text-sm shadow-xl" }).showToast();
        window.resetFilters = () => { document.getElementById('filter-year').value='2025'; document.getElementById('filter-role').value='all'; document.getElementById('filter-district').value='all'; applyFilters(); };
        function populateSelects() {
            const dS = document.getElementById('entry-district'), fD = document.getElementById('filter-district');
            DISTRICTS.forEach(d => { let o = `<option value="${d}">${d}</option>`; dS.innerHTML+=o; fD.innerHTML+=o; });
            const fR = document.getElementById('filter-role');
            document.getElementById('entry-role').querySelectorAll('optgroup').forEach(g => {
                const nG = document.createElement('optgroup'); nG.label = g.label;
                g.querySelectorAll('option').forEach(op => { const nO = document.createElement('option'); nO.value=op.value; nO.innerText=op.innerText; nG.appendChild(nO); });
                fR.appendChild(nG);
            });
        }

        init();
    </script>
</body>
</html>
